<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
 <title> New Document </title>
 <meta name="Generator" content="EditPlus">
 <meta name="Author" content="">
 <meta name="Keywords" content="">
 <meta name="Description" content="">
 <script>
  /**
  the actual dialog, we work on
  */
  var currentDialog = null;
  /**
  a pseudo format
  {uid : 'uid auto generated', texts: [{uid: 'uid auto generated', text:'reference on base64 in textmanager', next: 'a uid reference', wrong: false, points : 0, method: '?here?or'}], image: 'null or a image src or reference', x:null, y:null, w:null, h: null, color:null}
  we will see how this going to be formated in real
  */
  var data = [];
  /**
  static array of possible methods to be called
  unsupported are 'showInput','showFinalSelect'
  */
  var methods = ['-default-','showText','showKeyInput','showSelect','showTimer','clearScreen'];
  
  /**
  @method addText

  an editor function
  */
  function addText() {
    var currentTexts = currentDialog.texts;
    var ele = getElement('text_box');
    var _ele = createElement('input');
    _ele.setAttribute('type','text');
    _ele.setAttribute('id','text_'+currentTexts.length);
    onchange="doNothing(this.id)";
    ele.appendChild(_ele);
    _ele = createElement('select');
    _ele.setAttribute('id','text_'+currentTexts.length+'_next');
    _ele.setAttribute('onchange','doNothing(this.id);');
    var __ele = null;
    /*for (var i = 0; i < data.length; i++) {
      __ele.createElement('option');
      __ele.value = data[i].uid;
      __ele.appendChild(document.createTextNode(data[i].uid + ' ' + (data[i].texts.length ? data[i].texts[0] : '') ));
      _ele.appendChild(__ele);
    }*/
    ele.appendChild(_ele);
    _ele = createElement('input');
    _ele.setAttribute('type','checkbox');
    _ele.setAttribute('onchange','doNothing(this.id);');
    ele.appendChild(_ele);
    _ele.setAttribute('id','wrong_text_'+currentTexts.length);
    _ele.setAttribute('onchange','doNothing(this.id);');
    ele.appendChild(_ele);
    _ele = createElement('select');
    _ele.setAttribute('id','text_'+currentTexts.length+'_method');
    for (var i = 0; i < methods.length; i++) {
      __ele = createElement('option');
      __ele.value = methods[i];
      __ele.appendChild(document.createTextNode(methods[i]));
      _ele.appendChild(__ele);
    }
    _ele.setAttribute('onchange','doNothing(this.id);');
    ele.appendChild(_ele);
    _ele = createElement('br');
    ele.appendChild(_ele);
    var text = new GameText('text_'+currentTexts.length);
    currentDialog.texts.push(text);
    updateNextTextSelects();
  }
  /**
  @method updateNextTextSelects

  an editor function
  */
  function updateNextTextSelects() {
    var ele = null; 
    var _ele = null; 
    for (var j = 0; j < currentDialog.texts.length; j++) {    
      ele = getElement('text_'+j+'_next');
      ele.innerHTML = '';
      for (var i = 0; i < data.length; i++) {         
        _ele = createElement('option');
        _ele.value = data[i].uid;
        _ele.appendChild(document.createTextNode(data[i].uid + ' ' + (data[i].texts.length > 0 ? data[i].texts[0].text : '') ));
        ele.appendChild(_ele);
      }
    }
  }
  /**
  @method addDialog

  an editor function
  */
  function addDialog() {
    currentDialog = new GameDialog('dial_'+data.length);
    data.push(currentDialog);
    getElement('text_box').innerHTML = '';
    addText();
  }

  /*########################################
    Classes
  #########################################*/
  
  /**
  @GameText
  */
  function GameText(_id) {
    this.uid = _id;
    this.next = null;
    this.text = null;
    this.wrong = false;
    this.points = 0;
    this.method = null;
    this.audio = null;
    this.logo = null;
  }
  /**
  @class GameDialog
  */
  function GameDialog(_id) {
    this.uid = _id;
    this.texts = [];
    this.image = null;
    this.audio = null;
    this.x = null;
    this.y = null;
    this.w = null;
    this.h = null;
    this.color = null;
  }
  /**
  @class UidCounter
  */
  function UidCounter () {
    this.counters = [];

    this.createNew = function () {
      var abc = 'abcdefghjklmnopqrstuvwxyz0123456789_ABCDEFGHJKLMNOPQRSTUVWXYZ';
      var c = '';
      while (c.length < 5 || this.hasCounter(c) ){
        c = '';
        for (var i = 0; i < 5; i++) {
          c = c + abc.substr(Math.abs (Math.random() * abc.length), 1);
        }
        if (c.length == 5 && !isNaN(c)) {
          c = c.substr(0,4);
        }
      }
      this.counters.push(c);
      return c;
    };

    this.hasCounter = function(c) {
      for (var i = 0; i < this.counters.length; i++) {
        if (this.counters [i] == c) {
          return true;
        }
      }
      return false;
    };
    
    this.store = function() {
      return JSON.stringify(this, function(key, value) {
        return value;
      });
    }
    
    this.load = function(json) {
      this.counters = json['counters'];
    }
  }
  /**
  @class TextManager
  */
  function TextManager() {
    this.lan = 'en';
    this.currentLanguage = null;
    this.languages = [];
    /**
    @method getCurrentLanguage
    */
    this.getCurrentLanguage = function() {
      if (this.currentLanguage == null)
      {
        this.setCurrentLanguage(this.lan);
      }
      return this.currentLanguage;
    }
    /**
    @method setCurrentLanguage
    */
    this.setCurrentLanguage = function(_lan) {
      this.lan = _lan;
      if (this.hasLanguage(_lan))
      {
        this.currentLanguage = this.getLanguage(_lan);
      } else {
        this.currentLanguage = new TextLanguage(_lan);
        this.languages.push(this.currentLanguage);
      }
    }
    /**
    @method hasLanguage
    */
    this.hasLanguage = function(_lan) {
      for (var i = 0; i < this.languages.length; i++)
      {
        if (this.languages[i].language == _lan)
        {
          return true;
        }
      }
      return false;
    }
    /**
    @method getLanguage
    */
    this.getLanguage = function(_lan) {
      for (var i = 0; i < this.languages.length; i++)
      {
        if (this.languages[i].language == _lan)
        {
          return this.languages[i];
        }
      }
      return null;
    }
    /**
    @method setText
    */
    this.addText = function(_k, _v) {
      var cl = this.getCurrentLanguage();
      cl.setText(_k, _v);
    }
    /**
    @method getText
    */
    this.getText = function(_k) {
      var cl = this.getCurrentLanguage();
      return cl.getText(_k);
    }

    this.export = function() {
      return JSON.stringify(this, function(key, value) {
        if (key == 'languages') {
          value = [];
          for (var i = 0; i < this.languages.length; i++) {
            value.push(this.languages[i].language);
          }
        }
        return value;
      });
    }

    this.import = function(json) {
      this.lan = json['lan'];
      this.languages = [];
      if (json['languages'] != null) {
        for (var i = 0; i < json['languages'].length; i++)
        {
          this.languages[i] = new TextLanguage(json['languages'][i]['language']);    
        }
        this.currentLanguage = this.getLanguage(this.lan);
      }
    }
    /**
    @method load
    */
    this.load = function(json) {
      this.lan = json['lan'];
      this.languages = [];
      if (json['languages'] != null) {
        for (var i = 0; i < json['languages'].length; i++)
        {
          this.languages[i] = new TextLanguage();
          this.languages[i].load(json['languages'][i]);
        }
        this.currentLanguage = this.getLanguage(this.lan);
      }
    }
    /**
    @method store
    */
    this.store = function() {
      return JSON.stringify(this, function(key, value) {
        return value;
      });
    }
  };

  /**
  @class TextLanguage
  */
  function TextLanguage(_lan) {
    this.language = _lan;
    this.texts = []; //an array of keyvalues base64 encoded!
    /**
    @method setText
    */
    this.setText = function(_k, _v) {
      if (this.hasText(_k))
      {
        for (var i = 0; i < this.texts.length; i++)
        {
          if (this.texts[i].key == _k)
          {
            this.texts[i].value = Base64.encode(_v);
          }
        }
      } else {
        this.texts.push(new KeyValue(_k, Base64.encode(_v)));
      }
    }
    /**
    @method hasText
    */
    this.hasText = function(_k) {
      for (var i = 0; i < this.texts.length; i++)
      {
        if (this.texts[i].key == _k)
        {
          return true;
        }
      }
      return false;
    }
    /**
    returns the value of the key value pair or null!
    @method getText
    */
    this.getText = function(_k) {
      for (var i = 0; i < this.texts.length; i++)
      {
        if (this.texts[i].key === _k) {
          return Base64.decode(this.texts[i].value);
        }
      }
      return null;
    }
    /**
    returns the value of the key value pair or null!
    @method removeText
    */
    this.removeText = function(_k) {
      for (var i = 0; i < this.texts.length; i++)
      {
        if (this.texts[i].key == _k) {
          this.texts.splice(i,1);
        }
      }
    }
    /**
    @method load
    */
    this.load = function(json) {
      this.texts = [];
      for (var i = 0; i < json['texts'].length; i++) {
        if (!this.hasText(json['texts'][i]['key'])) {
          this.texts.push(new KeyValue(json['texts'][i]['key'], json['texts'][i]['value']));
        }
      }    
      this.language = json['language'];    
    }
    /**
    @method store
    */
    this.store = function() {
      return JSON.stringify(this, function(key, value) {
        return value;
      });
    }
  };
  /**
  @class MediaManager

  */
  function MediaManager() {
    this.lan = 'en';
    this.currentLanguage = null;
    this.languages = [];
    /**
    @method getCurrentLanguage
    */
    this.getCurrentLanguage = function() {
      if (this.currentLanguage == null)
      {
        this.setCurrentLanguage(this.lan);
      }
      return this.currentLanguage;
    }
    /**
    @method setCurrentLanguage
    */
    this.setCurrentLanguage = function(_lan) {
      this.lan = _lan;
      if (this.hasLanguage(_lan))
      {
        this.currentLanguage = this.getLanguage(_lan);
      } else {
        this.currentLanguage = new MediaLanguage(_lan);
        this.languages.push(this.currentLanguage);
      }
    }
    /**
    @method hasLanguage
    */
    this.hasLanguage = function(_lan) {
      for (var i = 0; i < this.languages.length; i++)
      {
        if (this.languages[i].language == _lan)
        {
          return true;
        }
      }
      return false;
    }
    /**
    @method getLanguage
    */
    this.getLanguage = function(_lan) {
      for (var i = 0; i < this.languages.length; i++)
      {
        if (this.languages[i].language == _lan)
        {
          return this.languages[i];
        }
      }
      return null;
    }

    this.addImage = function(_k, _v) {
      var cl = this.getCurrentLanguage();
      cl.addImage(_k, _v); 
    }

    this.hasImage = function(_k) {
      var cl = this.getCurrentLanguage();
      return cl.hasImage(_k);
    }

    this.getImage = function(_k) {
      var cl = this.getCurrentLanguage();
      return cl.getImage(_k);
    }

    this.removeImage = function(_k) {
      var cl = this.getCurrentLanguage();
      cl.removeImage(_k);
    }

    this.addAudio = function(_k, _v) {
      var cl = this.getCurrentLanguage();
      cl.addAudio(_k, _v); 
    }

    this.hasAudio = function(_k) {
      var cl = this.getCurrentLanguage(); 
      return cl.hasAudio(_k); 
    }

    this.getAudio = function(_k) {
      var cl = this.getCurrentLanguage(); 
      return cl.getAudio(_k); 
    }

    this.removeAudio = function(_k) {
      var cl = this.getCurrentLanguage(); 
      cl.removeAudio(_k); 
    }
    /**
    */
    this.export = function() {
      return JSON.stringify(this, function(key, value) {
        if (key == 'languages') {
          value = [];
          for (var i = 0; i < this.languages.length; i++) {
            value.push(this.languages[i].language);
          }
        }
        return value;
      });
    }
    /**
    */
    this.import = function(json) {
      this.lan = json['lan'];
      this.languages = [];
      if (json['languages'] != null) {
        for (var i = 0; i < json['languages'].length; i++) {
          this.languages[i] = new MediaLanguage(json['languages'][i]['language']);
        }
        this.currentLanguage = this.getLanguage(this.lan);
      }
    }
    /**
    @method load
    */
    this.load = function(json) {
      this.lan = json['lan'];
      this.languages = [];
      if (json['languages'] != null) {
        for (var i = 0; i < json['languages'].length; i++)
        {
          this.languages[i] = new MediaLanguage();
          this.languages[i].load(json['languages'][i]);
        }
        this.currentLanguage = this.getLanguage(this.lan);
      }
    }
    /**
    @method store
    */
    this.store = function() {
      return JSON.stringify(this, function(key, value) {
        return value;
      });
    }
  }
  /**
  @class MediaLanguage
  */
  function MediaLanguage(_lan) {
    this.language = _lan;
    this.imagess = []; //image and images are keywords
    this.audios = []; 
    /**
    @method addImage
    */
    this.addImage = function(_k, _v) {
      if (this.hasImage(_k))
      {
        for (var i = 0; i < this.imagess.length; i++)
        {
          if (this.imagess[i].key == _k)
          {
            this.imagess[i].value = _v;
          }
        }
      } else {
        this.imagess.push(new KeyValue(_k, _v));
      }
    }
    /**
    @method hasImage
    */
    this.hasImage = function(_k) {
      for (var i = 0; i < this.imagess.length; i++)
      {
        if (this.imagess[i].key == _k)
        {
          return true;
        }
      }
      return false;
    }
    /**
    returns the value of the key value pair or null!
    @method getImage
    */
    this.getImage = function(_k) {
      for (var i = 0; i < this.imagess.length; i++)
      {
        if (this.imagess[i].key === _k) {
          return this.imagess[i].value;
        }
      }
      return null;
    }
    /**
    @method removeImage
    */
    this.removeImage = function(_k) {
      for (var i = 0; i < this.imagess.length; i++)
      {
        if (this.imagess[i].key == _k) {
          this.imagess.splice(i,1);
        }
      }
    }
    /**
    @method addAudio
    */
    this.addAudio = function(_k, _v) {
      if (this.hasAudio(_k))
      {
        for (var i = 0; i < this.audios.length; i++)
        {
          if (this.audios[i].key == _k)
          {
            this.audios[i].value = _v;
          }
        }
      } else {
        this.audios.push(new KeyValue(_k, _v));
      }
    }
    /**
    @method hasAudio
    */
    this.hasAudio = function(_k) {
      for (var i = 0; i < this.audios.length; i++)
      {
        if (this.audios[i].key == _k)
        {
          return true;
        }
      }
      return false;
    }
    /**
    returns the value of the key value pair or null!
    @method getAudio
    */
    this.getAudio = function(_k) {
      for (var i = 0; i < this.audios.length; i++)
      {
        if (this.audios[i].key === _k) {
          return this.audios[i].value;
        }
      }
      return null;
    }
    /**
    @method removeAudio
    */
    this.removeAudio = function(_k) {
      for (var i = 0; i < this.audios.length; i++)
      {
        if (this.audios[i].key == _k) {
          this.audios.splice(i,1);
        }
      }
    }
    /**
    @method load
    */
    this.load = function(json) {
      this.imagess = [];
      this.audios = [];
      for (var key in json) {
        switch (key)
        {
        case 'imagess':
          for (var i = 0; i < json[key].length; i++)
          {
            //if (json[key][i]['key'].length == 5) {
            this.imagess.push(new KeyValue(json[key][i]['key'], json[key][i]['value'] ) );
            //}
          }
        break;
         case 'audios':
          for (var i = 0; i < json[key].length; i++)
          {
            //if (json[key][i]['key'].length == 5) {
            this.audios.push(new KeyValue(json[key][i]['key'], json[key][i]['value'] ) );
            //}
          }
        break;
        default: 
          this[key] = json[key];
        break;
        }		
      }
    }
    /**
    @method store
    */
    this.store = function() {
      return JSON.stringify(this, function(key, value) {
        return value;
      });
    }
    /**
    @method export
    */
    this.export = function() {
      return JSON.stringify(this, function(key, value) {
        if (key == 'imagess') {
          return this.imagess.length;
        }
        if (key == 'audios') {
          return this.audios.length;
        }
        return value;
      });
    }
    /**
    @method import
    */
    this.import = function(json) {
      this.imagess = [];
      this.audios = [];
      for (var key in json) {
        switch (key)
        {
        case 'imagess':
          
        break;
        case 'audios':
          
        break;
        default: 
          this[key] = json[key];
        break;
        }		
      }
    }
  };

  /*########################################

  #########################################*/

  function getElement(id) {
    return document.getElementById(id);
  }

  function createElement(type) {
    return document.createElement(type);
  }

  function doNothing(id) {
    console.log('method "'+id+'" not implemented');
  }
  /**
  a method that is the demonstrate the basics of the game-engine
  missing is 
    -requestAnimationFrame and 
    -an intervalListener for non animation related processes aka threads
    -double-buffering  
  */
  function drawCanvas() {
    var cvs = getElement('canvas');
    cvs.width = 480;
    cvs.height = 320;
    var ctx = cvs.getContext('2d');

    ctx.fillStyle = 'rgba(102,102,204,0.75)';
    ctx.strokeStyle = 'rgba(204,204,102,0.75)';

    var img = new Image();
    img.src = "http://hogventure.com/image/3piggies.jpg";
    ctx.drawImage(img, 0, 0, 480, 320);
    
    ctx.beginPath();
    ctx.moveTo(50,50);
    ctx.lineTo(150, 50);
    ctx.bezierCurveTo(150, 50, 175, 50, 175, 75);
    ctx.lineTo(175, 100);
    ctx.bezierCurveTo(175, 100, 175, 125, 150, 125);
    ctx.lineTo(75, 125);
    ctx.lineTo(50, 150);
    ctx.lineTo(50, 125);
    ctx.bezierCurveTo(50, 125, 25, 125, 25, 100);
    ctx.lineTo(25, 75);
    ctx.bezierCurveTo(25, 75, 25, 50, 50, 50);
    
    
    for (var i = 0; i < 3; i++) {
      ctx.moveTo(250, 50 + i * 75);
      ctx.lineTo(350, 50 + i * 75);
      ctx.bezierCurveTo(350, 50 + i * 75, 375, 50 + i * 75, 375, 75 + i * 75);
      ctx.lineTo(375, 100 + i * 75);
      ctx.bezierCurveTo(375, 100 + i * 75, 375, 125 + i * 75, 350, 125 + i * 75);
      if (i==2) {
        //ctx.lineTo(350, 125 + i * 75);
        ctx.lineTo(350, 150 + i * 75);
        ctx.lineTo(325, 125 + i * 75);
      } 
      ctx.lineTo(250, 125 + i * 75);
      ctx.bezierCurveTo(250, 125 + i * 75, 225, 125 + i * 75, 225, 100 + i * 75);
      ctx.lineTo(225, 75 + i * 75);
      ctx.bezierCurveTo(225, 75 + i * 75, 225, 50 + i * 75, 250, 50 + i * 75);
    }
    ctx.closePath();
    ctx.stroke();
    ctx.fill();
  }

  function init() {
    addDialog();
    drawCanvas();
  }
  if (window.ondeviceready) {
    document.addEventListener("deviceready", init, false);
  } else {
    window.onload = function() {
      //intervalId =
      setTimeout(init, 100);
    }
  }
 </script>
</head>
<body>
<button id="add_text_btn" onclick="addText();">add text</button>
<div id="text_box"> 
 <!--input type="text" id="text_0" onchange="" /><select id="text_0_next" onchange="" ></select><input type="checkbox" id="wrong_text_0" data-tooltip="wrong" onchange="" /><select id="text_0_method" onchange="" ></select><br /-->
 <!--you may append more childs-->
</div>
<select id="text_general_method" onchange="doNothing(this.id);" ><option>---</option></select><br />
<button id="add_dialog_btn" onclick="addDialog();">add dialog</button><br />
<hr />
<h1>Help</h1>
the dialog game is a simple text adventure with text-inputs and selections of answers or questions.<br />
Each dialog can have a background image or it will use the previous displayed background. Dialogs give audio support for background music, a single text or selection can play sound as a click reaction.<br />
The data model contains dialogs and texts. A dialog is a single collection of one or more texts. A dialog will be visual presented in a bubble like you see on the left or a multi bubble like on the right.<br />
<canvas id="canvas" style="width: 480px; height: 320px; background: #ddd;"></canvas>
</body>
</html>
